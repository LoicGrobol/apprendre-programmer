on: [push, pull_request]

name: CI-CD

jobs:
  CI-CD:
    runs-on: ${{ matrix.os }}

    name: ${{ matrix.os }} (${{ matrix.python-version }})

    strategy:
      matrix:
        python-version: [3.9]
        os: [ubuntu-20.04]
    
    env:
      JEKYLL_DEBUG: "true"

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Set up Python ğŸ
        uses: actions/setup-python@v3
        with:
            python-version: ${{ matrix.python-version }}
            cache: 'pip'
            cache-dependency-path: '${{ github.workspace }}/requirements.txt'
      
      - name: Install dependencies ğŸ’ğŸ»
        run: |
          pip install -U -r "${{ github.workspace }}/requirements.txt"
      
      - name: Build slides ğŸ“š
        run: |
          shopt -s globstar
          jupytext --to ipynb ${{ github.workspace }}/**/*.py.md
          jupyter nbconvert --execute --allow-errors --to html ${{ github.workspace }}/**/*.py.ipynb
          jupyter nbconvert --to slides ${{ github.workspace }}/slides/**/*-slides.py.ipynb
      
      - name: Get node cache ğŸª¢
        uses: actions/cache@v2
        with:
          path: vendor/bundle
          key: ${{ runner.os }}-gems-${{ hashFiles('**/Gemfile') }}
          restore-keys: |
            ${{ runner.os }}-gems-
      
      - name: ğŸ’ setup ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: 3.0
          bundler-cache: true

      - name: ğŸ”¨ install dependencies & build site
        uses: limjh16/jekyll-action-ts@v2
        with:
          enable_cache: true
          custom_opts: '--verbose'
      
      - name: Prevent Github Jekyll build ğŸ™…ğŸ»
        run: |
          touch _site/.nojekyll
      
      - name: â¬†ï¸ Upload site for inspection
        uses: actions/upload-artifact@v3
        with:
          name: site
          path: ${{ github.workspace }}/_site/

      - name: Deploy to GitHub Pages ğŸš€
        if: github.ref == 'refs/heads/main'
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          branch: gh-pages
          folder: _site
          single-commit: true

  # prebuild-binder:
  #   runs-on: ubuntu-latest
  #   steps:
  #   - name: Checkout Code
  #     uses: actions/checkout@v2

  #   - name: update jupyter dependencies with repo2docker
  #     uses: jupyterhub/repo2docker-action@master
  #     with:
  #       NO_PUSH: true
  #       MYBINDERORG_TAG: ${{ github.event.ref }}

